# Jira Integration Workflow
# Automatically syncs GitHub PRs and commits with Jira tickets
#
# Prerequisites:
# 1. Add these secrets to your GitHub repository:
#    - JIRA_BASE_URL: https://vaspinet.atlassian.net
#    - JIRA_USER_EMAIL: Your Atlassian account email
#    - JIRA_API_TOKEN: API token from https://id.atlassian.com/manage-profile/security/api-tokens
#
# 2. Use Jira ticket IDs in branch names or commit messages:
#    - Branch: feature/VASPNET-123-add-feature
#    - Commit: "VASPNET-123: Add new feature"

name: Jira Integration

on:
  pull_request:
    types: [opened, edited, closed, reopened]
  push:
    branches: [main, develop]
  create:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'

env:
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
  JIRA_PROJECT_KEY: SCRUM

jobs:
  # Extract Jira ticket ID from branch name or PR title
  extract-ticket:
    name: Extract Jira Ticket
    runs-on: ubuntu-latest
    outputs:
      ticket_id: ${{ steps.extract.outputs.ticket_id }}
      has_ticket: ${{ steps.extract.outputs.has_ticket }}
    steps:
      - name: Extract Jira ticket ID
        id: extract
        run: |
          # Try to extract from branch name first
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Pattern: SCRUM-123 or scrum-123
          TICKET_PATTERN="[Ss][Cc][Rr][Uu][Mm]-[0-9]+"
          
          # Check branch name
          if [[ "$BRANCH_NAME" =~ ($TICKET_PATTERN) ]]; then
            TICKET_ID=$(echo "${BASH_REMATCH[1]}" | tr '[:lower:]' '[:upper:]')
            echo "Found ticket in branch: $TICKET_ID"
            echo "ticket_id=$TICKET_ID" >> $GITHUB_OUTPUT
            echo "has_ticket=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check PR title
          if [[ "$PR_TITLE" =~ ($TICKET_PATTERN) ]]; then
            TICKET_ID=$(echo "${BASH_REMATCH[1]}" | tr '[:lower:]' '[:upper:]')
            echo "Found ticket in PR title: $TICKET_ID"
            echo "ticket_id=$TICKET_ID" >> $GITHUB_OUTPUT
            echo "has_ticket=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "No Jira ticket found"
          echo "has_ticket=false" >> $GITHUB_OUTPUT

  # Update Jira ticket when PR is opened
  pr-opened:
    name: PR Opened - Move to In Review
    runs-on: ubuntu-latest
    needs: extract-ticket
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened' && 
      needs.extract-ticket.outputs.has_ticket == 'true'
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition to In Review
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ needs.extract-ticket.outputs.ticket_id }}
          transition: "In Review"

      - name: Add PR link comment
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ needs.extract-ticket.outputs.ticket_id }}
          comment: |
            Pull Request opened: ${{ github.event.pull_request.html_url }}
            
            *Title:* ${{ github.event.pull_request.title }}
            *Author:* ${{ github.event.pull_request.user.login }}
            *Branch:* ${{ github.head_ref }} → ${{ github.base_ref }}

  # Update Jira ticket when PR is merged
  pr-merged:
    name: PR Merged - Move to Done
    runs-on: ubuntu-latest
    needs: extract-ticket
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.event.pull_request.merged == true &&
      needs.extract-ticket.outputs.has_ticket == 'true'
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Transition to Done
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ needs.extract-ticket.outputs.ticket_id }}
          transition: "Done"

      - name: Add merge comment
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ needs.extract-ticket.outputs.ticket_id }}
          comment: |
            ✅ Pull Request merged!
            
            *PR:* ${{ github.event.pull_request.html_url }}
            *Merged by:* ${{ github.event.pull_request.merged_by.login }}
            *Commit:* ${{ github.event.pull_request.merge_commit_sha }}

  # Update Jira ticket when PR is closed without merge
  pr-closed:
    name: PR Closed - Add Comment
    runs-on: ubuntu-latest
    needs: extract-ticket
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.event.pull_request.merged == false &&
      needs.extract-ticket.outputs.has_ticket == 'true'
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Add closed comment
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ needs.extract-ticket.outputs.ticket_id }}
          comment: |
            ❌ Pull Request closed without merge
            
            *PR:* ${{ github.event.pull_request.html_url }}
            *Closed by:* ${{ github.actor }}

  # Validate PR has Jira ticket reference
  validate-ticket:
    name: Validate Jira Ticket Reference
    runs-on: ubuntu-latest
    needs: extract-ticket
    if: github.event_name == 'pull_request'
    steps:
      - name: Check for Jira ticket
        run: |
          if [[ "${{ needs.extract-ticket.outputs.has_ticket }}" != "true" ]]; then
            echo "::warning::No Jira ticket found in branch name or PR title."
            echo "Consider using format: SCRUM-123 in your branch name or PR title"
            echo ""
            echo "Examples:"
            echo "  Branch: feature/SCRUM-123-add-feature"
            echo "  PR Title: SCRUM-123: Add new feature"
          else
            echo "✅ Found Jira ticket: ${{ needs.extract-ticket.outputs.ticket_id }}"
          fi
